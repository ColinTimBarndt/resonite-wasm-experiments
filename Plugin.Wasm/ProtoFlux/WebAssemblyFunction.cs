using System;
using Elements.Core;
using Plugin.Wasm.Components;
using ProtoFlux.Core;
using ProtoFlux.Runtimes.Execution;

namespace Plugin.Wasm.ProtoFlux;

/// <summary>
/// A base class for all JIT-compiled WebAssembly Function ProtoFlux nodes.
/// </summary>
[NodeCategory("Web Assembly")]
public abstract class WebAssemblyFunction : VoidNode<ExecutionContext>, IWebAssemblyNode
{
#pragma warning disable CS8618 // Initializer generated by FluxWeaver

    /// <summary>A reference to the WebAssembly function to call if the signature matches.</summary>
    public readonly GlobalRef<WebAssemblyInstance.FunctionExport?> Function;

#pragma warning restore CS8618

    private void OnFunctionChanged(WebAssemblyInstance.FunctionExport? function, ExecutionContext ctx)
    {
        UniLog.Log($"OnFunctionChanged '{function?.Name}'");
        TrySetFunction(function?.Function);
    }

    /// <inheritdoc/>
    public abstract FunctionSignature Signature { get; }

    /// <summary>
    /// Sets the delegate which is used by the JIT-compiled class.
    /// The method does not ensure that the <paramref name="delegate"/>
    /// is of the correct type.
    /// </summary>
    protected abstract void InternalSetDelegate(Delegate? @delegate);

    /// <inheritdoc/>
    public bool TrySetFunction(Wasmtime.Function? func)
    {
        UniLog.Log($"Try set function {func} on {Signature}");
        if (func is null)
        {
            InternalSetDelegate(null);
            return true;
        }
        var @delegate = Signature.TryCreateDelegate(func);
        UniLog.Log($"Delegate: {@delegate}");
        if (@delegate is null) return false;
        InternalSetDelegate(@delegate);
        return true;
    }
}
